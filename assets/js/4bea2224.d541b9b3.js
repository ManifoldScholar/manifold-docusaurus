"use strict";(self.webpackChunkmanifold_docusaurus=self.webpackChunkmanifold_docusaurus||[]).push([[7261],{80665:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>u});var a=t(74848),s=t(28453),o=t(11470),r=t(19365);const i={id:"backup_restore",title:"Backup and Restore",sidebar_label:"Backup and Restore"},l=void 0,c={id:"administering/backup_restore",title:"Backup and Restore",description:"The steps involved with backing up your instance and restoring from backup will vary depending on how you installed Manifold and what operating system you installed it on. The content on this page is meant to get you started. It is not exhaustive, nor have the scripts below been thoroughly tested in different environments.",source:"@site/docs/administering/backup_restore.md",sourceDirName:"administering",slug:"/administering/backup_restore",permalink:"/manifold-docusaurus/docs/administering/backup_restore",draft:!1,unlisted:!1,editUrl:"https://github.com/ManifoldScholar/manifold-docusaurus/edit/master/docs/administering/backup_restore.md",tags:[],version:"current",frontMatter:{id:"backup_restore",title:"Backup and Restore",sidebar_label:"Backup and Restore"},sidebar:"docs",previous:{title:"Storage",permalink:"/manifold-docusaurus/docs/administering/storage"},next:{title:"Troubleshooting",permalink:"/manifold-docusaurus/docs/administering/troubleshooting"}},d={},u=[{value:"Backup Manifold",id:"backup-manifold",level:2},{value:"Restore a Backup",id:"restore-a-backup",level:2}];function p(e){const n={admonition:"admonition",code:"code",h2:"h2",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"The steps involved with backing up your instance and restoring from backup will vary depending on how you installed Manifold and what operating system you installed it on. The content on this page is meant to get you started. It is not exhaustive, nor have the scripts below been thoroughly tested in different environments."}),"\n",(0,a.jsx)(n.admonition,{type:"caution",children:(0,a.jsx)(n.p,{children:"Manifold is open-source software, and you are ultimately responsible for your data. Proceed with caution and make sure you understand what the following scripts do before you run them."})}),"\n",(0,a.jsx)(n.h2,{id:"backup-manifold",children:"Backup Manifold"}),"\n",(0,a.jsx)(n.p,{children:"Manifold stores user data in two places: (1) the PostgreSQL database and (2) the file system."}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsx)(n.p,{children:"It is also possible for Manifold to store files in cloud storage (AWS or GCS); however, backing up cloud storage buckets is outside the scope of these instructions."})}),"\n",(0,a.jsx)(n.p,{children:"Backing up a Manifold instance involves backing up files and creating a database dump. The specific commands required to backup a Manifold installation depend on how Manifold was installed. Select your installation type from the options below to see sample commands you can use for backing up your instance."}),"\n",(0,a.jsxs)(n.p,{children:["Each of the backup scripts below will create a tar archive that contains a ",(0,a.jsx)(n.code,{children:"dump.sql"})," file and an ",(0,a.jsx)(n.code,{children:"uploads"})," directory. These outputs can be used as inputs for the restore scripts that are described further below."]}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsx)(n.p,{children:"If you downloaded one of our operating system packages for Centos or Ubuntu, follow the \u201cPackage Install\u201d instructions. The \u201cSource Install\u201d instructions assumes that services are managed by systemd in an Ubuntu environment."})}),"\n",(0,a.jsxs)(o.A,{groupId:"install-type",defaultValue:"package",values:[{label:"Package Install",value:"package"},{label:"Source Install",value:"source"}],children:[(0,a.jsxs)(r.A,{value:"package",children:[(0,a.jsx)(n.p,{children:"Use this Bash script as a starting point for automating your instance backups. This script will need to be run as root."}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\n# Define directories\nBACKUP_DIR=/var/opt/manifold/backups/`date +"%m-%d-%y"`\nBACKUP_STAGING=$BACKUP_DIR/staged\nBACKUP_FILE=$BACKUP_DIR/manifold-backup-`date +"%m-%d-%y-%s"`.tar\nBACKUP_DB_HOST=/var/opt/manifold/postgresql\nBACKUP_DB_PORT=3034\nBACKUP_DB_USER=manifold\nBACKUP_FILES_ROOT=/var/opt/manifold/api\n\n# Create the staging directory (and parents) as the manifold user.\nsu - manifold -c "mkdir -p $BACKUP_STAGING"\n\n# Dump the database to the staging directory\nsu - manifold -c "/opt/manifold/embedded/bin/pg_dump \\\n  --user=$BACKUP_DB_USER \\\n  --port=$BACKUP_DB_PORT \\\n  --host=$BACKUP_DB_HOST manifold_production > $BACKUP_STAGING/dump.sql"\n\n# Backup the uploads directory\ncd $BACKUP_FILES_ROOT\ntar -cvf $BACKUP_FILE uploads\n\n# Add the SQL dump to the tar archive\ncd $BACKUP_STAGING\ntar -rvf $BACKUP_FILE dump.sql\ncd $BACKUP_DIR\n\n# Clean up the staging directory.\nsu - manifold -c "rm -rf $BACKUP_STAGING"\n\n# Output backup path\necho "Backup has been created at $BACKUP_FILE"\n'})})]}),(0,a.jsxs)(r.A,{value:"source",children:[(0,a.jsxs)(n.p,{children:["Use this Bash script as a starting point for automating your instance backups. This example assumes that your instance is installed at ",(0,a.jsx)(n.code,{children:"/home/manifold/deploy/current"})," and that the files are owned by a ",(0,a.jsx)(n.code,{children:"manifold"})," user."]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\n# These should be set in the application user\'s environment.\n#RAILS_DB_NAME=\n#RAILS_DB_PASS=\n#RAILS_DB_USER=\n\nUSER_DIR=/home/manifold\nBACKUP_DIR=$USER_DIR/backups/`date +"%m-%d-%y"`\nBACKUP_STAGING=$BACKUP_DIR/staged\nBACKUP_FILE=$BACKUP_DIR/manifold-backup-`date +"%m-%d-%y-%s"`.tar\nBACKUP_DB_HOST=localhost\nBACKUP_DB_PORT=5432\nBACKUP_FILES_ROOT=/home/manifold/deploy/shared/api/public/\nPG_URL="postgres://$RAILS_DB_USER:$RAILS_DB_PASS@$BACKUP_DB_HOST:$BACKUP_DB_PORT/$RAILS_DB_NAME"\n\n# Create the staging directory (and parents) as the manifold user.\necho "Creating the staging directory at $BACKUP_STAGING..."\nmkdir -p $BACKUP_STAGING\n\n# Dump the database to the staging directory\necho "Creating a database dump..."\npg_dump $PG_URL > $BACKUP_STAGING/dump.sql\n\n# Backup the uploads directory\necho "Creating a tar archive..."\ncd $BACKUP_FILES_ROOT\ntar -cf $BACKUP_FILE --transform=s/system/uploads/ system/\n\n# Add the SQL dump to the tar archive\necho "Adding the dump to the archive..."\ncd $BACKUP_STAGING\ntar -rf $BACKUP_FILE dump.sql\ncd $BACKUP_DIR\n\n# Clean up the staging directory.\necho "Cleaning the staging dir..."\nrm -rf $BACKUP_STAGING\n\n# Output backup path\necho "Backup has been created at $BACKUP_FILE"\n'})})]})]}),"\n",(0,a.jsx)(n.h2,{id:"restore-a-backup",children:"Restore a Backup"}),"\n",(0,a.jsxs)(n.p,{children:["The following scripts take a single input, which is the path to a tar archive. That archive should include a database dump called ",(0,a.jsx)(n.code,{children:"dump.sql"})," and a directory called ",(0,a.jsx)(n.code,{children:"uploads"})," that includes attachment data. The backup scripts above will produce an archive that conforms to this specification."]}),"\n",(0,a.jsxs)(n.p,{children:["Assuming you call the restore script ",(0,a.jsx)(n.code,{children:"manifold-restore.sh"})," and you were in a directory with a backup generated by the backup script above, you would restore with this command:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"./manifold-restore.sh manifold-backup-11-17-20-1605640139.tar\n"})}),"\n",(0,a.jsxs)(o.A,{groupId:"install-type",defaultValue:"package",values:[{label:"Package Install",value:"package"},{label:"Source Install",value:"source"}],children:[(0,a.jsxs)(r.A,{value:"package",children:[(0,a.jsx)(n.p,{children:"This script will need to be run as root."}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\nRESTORE_DIR=/var/opt/manifold/backups/restore-staging\nRESTORE_ARCHIVE_PATH=$1\nRESTORE_ARCHIVE_FILE=$(basename $RESTORE_ARCHIVE_PATH)\nDB_HOST=/var/opt/manifold/postgresql\nDB_PORT=3034\nDB_USER=manifold\nDB_NAME=manifold_production\nBACKUP_FILES_ROOT=/var/opt/manifold/api\nTOKEN=$(cat /dev/urandom | tr -dc \'a-zA-Z0-9\' | fold -w 32 | head -n 1)\n\nif [ ! -f "$RESTORE_ARCHIVE_PATH" ]; then\n    echo "$RESTORE_ARCHIVE_PATH does not exist."\n    exit 1\nfi\n\necho "Creating the restore staging directory at $RESTORE_DIR..."\nsu - manifold -c "mkdir -p $RESTORE_DIR"\n\necho "Extracting the restore archive..."\ncp $RESTORE_ARCHIVE_PATH $RESTORE_DIR/\ncd $RESTORE_DIR\ntar -xf $RESTORE_ARCHIVE_FILE\n\necho "Checking for an existing directory at $BACKUP_FILES_ROOT/uploads..."\nif [ -d $BACKUP_FILES_ROOT/uploads ]\nthen\n    echo "$BACKUP_FILES_ROOT/uploads exists..."\n    echo "Moving $BACKUP_FILES_ROOT/uploads to $BACKUP_FILES_ROOT/upload-bak-$TOKEN"\n    mv $BACKUP_FILES_ROOT/uploads $BACKUP_FILES_ROOT/uploads-bak-$TOKEN\nfi\n\necho "Restoring uploads dir..."\nmv uploads $BACKUP_FILES_ROOT/\n\necho "Backup existing DB to ~/manifold_production_dump-$TOKEN.sql"\nsu - manifold -c "/opt/manifold/embedded/bin/pg_dump \\\n  --user=$DB_USER \\\n  --port=$DB_PORT \\\n  --host=$DB_HOST manifold_production > ~/manifold_production_dump-$TOKEN.sql"\n\necho "Stopping manifold services..."\nmanifold-ctl stop\n\necho "Starting postgresql..."\nmanifold-ctl start postgresql\n\necho "Dropping existing database..."\nDISABLE_DATABASE_ENVIRONMENT_CHECK=1 manifold-api db:drop\n\necho "Create new database..."\nmanifold-api db:create\n\necho "Importing database dump..."\nmanifold-psql $DB_NAME < dump.sql\n\necho "Starting services..."\nmanifold-ctl start\n\necho "Cleaning up the restore staging directory..."\nsu - manifold -c "rm -rf $RESTORE_DIR"\n\necho "Restore complete."\necho "You should reindex the content on your instance with this command:"\necho "  manifold-api manifold:search:reindex"\n'})})]}),(0,a.jsx)(r.A,{value:"source",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\n# These should be set in the application user\'s environment.\n#RAILS_DB_NAME=\n#RAILS_DB_PASS=\n#RAILS_DB_USER=\n\nUSER_DIR=/home/manifold\nCURRENT_DIR=$USER_DIR/deploy/current\nRESTORE_DIR=$USER_DIR/backups/restore-staging\nRESTORE_ARCHIVE_PATH=$1\nRESTORE_ARCHIVE_FILE=$(basename $RESTORE_ARCHIVE_PATH)\nBACKUP_DB_HOST=localhost\nBACKUP_DB_PORT=5432\nBACKUP_FILES_ROOT=/home/manifold/deploy/shared/api/public\nPG_URL="postgres://$RAILS_DB_USER:$RAILS_DB_PASS@$BACKUP_DB_HOST:$BACKUP_DB_PORT/$RAILS_DB_NAME"\nTOKEN=$(cat /dev/urandom | tr -dc \'a-zA-Z0-9\' | fold -w 32 | head -n 1)\n\necho "Creating the restore staging directory at $RESTORE_DIR..."\nmkdir -p $RESTORE_DIR\n\necho "Extracting the restore archive..."\ncp $RESTORE_ARCHIVE_PATH $RESTORE_DIR/\ncd $RESTORE_DIR\ntar -xf $RESTORE_ARCHIVE_FILE\n\necho "Checking for an existing directory at $BACKUP_FILES_ROOT/system..."\nif [ -d $BACKUP_FILES_ROOT/system ]\nthen\n    echo "$BACKUP_FILES_ROOT/system exists..."\n    echo "Moving $BACKUP_FILES_ROOT/system to $BACKUP_FILES_ROOT/system-bak-$TOKEN"\n    mv $BACKUP_FILES_ROOT/system $BACKUP_FILES_ROOT/system-bak-$TOKEN\nfi\n\necho "Restoring uploads dir to $BACKUP_FILES_ROOT/system..."\nmv uploads $BACKUP_FILES_ROOT/system\n\necho "Backup existing DB to ~/manifold_production_dump-$TOKEN.sql"\npg_dump $PG_URL > ~/manifold_production_dump-$TOKEN.sql\n\necho "Stopping manifold services..."\nsudo systemctl stop manifold\n\necho "Dropping existing database..."\ncd $CURRENT_DIR/api\nDISABLE_DATABASE_ENVIRONMENT_CHECK=1 rails db:drop\n\necho "Create new database..."\ncd $CURRENT_DIR/api\nrails db:create\n\necho "Importing database dump..."\ncd $RESTORE_DIR\npsql $PG_URL < dump.sql\n\necho "Starting services..."\nsudo systemctl start manifold\n\necho "Cleaning up the restore staging directory..."\nrm -rf $RESTORE_DIR\n\necho "Restore complete."\necho "You should reindex the content on your instance with these commands:"\necho "  cd $CURRENT_DIR/api"\necho "  rails manifold:search:reindex"\n'})})})]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},19365:(e,n,t)=>{t.d(n,{A:()=>r});t(96540);var a=t(34164);const s={tabItem:"tabItem_Ymn6"};var o=t(74848);function r(e){let{children:n,hidden:t,className:r}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,a.A)(s.tabItem,r),hidden:t,children:n})}},11470:(e,n,t)=>{t.d(n,{A:()=>I});var a=t(96540),s=t(34164),o=t(23104),r=t(56347),i=t(205),l=t(57485),c=t(31682),d=t(70679);function u(e){return a.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:n,children:t}=e;return(0,a.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:t,attributes:a,default:s}}=e;return{value:n,label:t,attributes:a,default:s}}))}(t);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function h(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function m(e){let{queryString:n=!1,groupId:t}=e;const s=(0,r.W6)(),o=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,l.aZ)(o),(0,a.useCallback)((e=>{if(!o)return;const n=new URLSearchParams(s.location.search);n.set(o,e),s.replace({...s.location,search:n.toString()})}),[o,s])]}function _(e){const{defaultValue:n,queryString:t=!1,groupId:s}=e,o=p(e),[r,l]=(0,a.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!h({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const a=t.find((e=>e.default))??t[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:n,tabValues:o}))),[c,u]=m({queryString:t,groupId:s}),[_,f]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[s,o]=(0,d.Dv)(t);return[s,(0,a.useCallback)((e=>{t&&o.set(e)}),[t,o])]}({groupId:s}),R=(()=>{const e=c??_;return h({value:e,tabValues:o})?e:null})();(0,i.A)((()=>{R&&l(R)}),[R]);return{selectedValue:r,selectValue:(0,a.useCallback)((e=>{if(!h({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),f(e)}),[u,f,o]),tabValues:o}}var f=t(92303);const R={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=t(74848);function g(e){let{className:n,block:t,selectedValue:a,selectValue:r,tabValues:i}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,o.a_)(),d=e=>{const n=e.currentTarget,t=l.indexOf(n),s=i[t].value;s!==a&&(c(n),r(s))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=l.indexOf(e.currentTarget)+1;n=l[t]??l[0];break}case"ArrowLeft":{const t=l.indexOf(e.currentTarget)-1;n=l[t]??l[l.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":t},n),children:i.map((e=>{let{value:n,label:t,attributes:o}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:a===n?0:-1,"aria-selected":a===n,ref:e=>l.push(e),onKeyDown:u,onClick:d,...o,className:(0,s.A)("tabs__item",R.tabItem,o?.className,{"tabs__item--active":a===n}),children:t??n},n)}))})}function E(e){let{lazy:n,children:t,selectedValue:o}=e;const r=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=r.find((e=>e.props.value===o));return e?(0,a.cloneElement)(e,{className:(0,s.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:r.map(((e,n)=>(0,a.cloneElement)(e,{key:n,hidden:e.props.value!==o})))})}function A(e){const n=_(e);return(0,b.jsxs)("div",{className:(0,s.A)("tabs-container",R.tabList),children:[(0,b.jsx)(g,{...n,...e}),(0,b.jsx)(E,{...n,...e})]})}function I(e){const n=(0,f.A)();return(0,b.jsx)(A,{...e,children:u(e.children)},String(n))}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var a=t(96540);const s={},o=a.createContext(s);function r(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);